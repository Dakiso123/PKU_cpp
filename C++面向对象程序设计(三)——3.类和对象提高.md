# C++面向对象程序设计(三)——3.类和对象提高

本文是中国大学MOOC，北京大学[程序设计与算法（三）C++面向对象程序设计](https://www.icourse163.org/learn/PKU-1002029030#/learn/announce)第三周笔记。

## 一 this 指针

### Ｃ++ 到 C程序的翻译

```cpp
//C++
class CCar{
  public:
    	int price;
    	void SetPtice(int p);
};
void CCar::SetPrice( int p ){
    price = p;
}
int main(){
    CCar car;
    car.SetPrice( 20000 );
    return 0;
}
```

```cpp
//C
struct CCar{
    int price;
};
void SetPrice( struct CCar * this, int p)
{
    this －> price = p;
}
int main(){
    struct CCar car;
    SetPrice( & car, 20000 );
    return 0;
}
```

对比一下这两个程序，我们可以看到：

`this` 作用就是指向**成员函数所作用的对象**。在非静态成员函数中可以直接使用`this`来代表指向该函数作用的对象的指针。

我们可以看一个案例：

```cpp
class Complex{
    public:
    	double real,imag;
    	void Print(){
            cout << real << "," << imag;
        }
    Complex( double r, double i ):real( r ),imag( i )
    {}
    Complex AddOne(){
        this -> real ++;		//等价于 real++
        this -> Print();		//等于于 Print
        return * this;
    }
};

int main(){
    Complex c1(1,1),c2(0,0);
    c2 = c1.AddOne();
    return 0;
}//输出 2,1
```

需要注意的是：

静态成员函数中不能使用`this`指针，因为静态成员函数并不具体作用于某个对象。所以，静态成员函数的真实参数的个数，就是程序中写出的参数个数。

然而，类的非静态成员函数，真实的参数比所写的参数多１，多的这个就是this指针。

## 二 静态成员

### 基本概念

在定义前面加了`static`关键字的成员

```cpp
class CRectangle
{
    private:
    	int w, h;
    		static int nTotalArea;		//静态成员变量
    		static int nTotalNumber;
    public:
    		CRectangle(int w_, int h_);
    		~CRectangle();
    		static void PrintTotal();		//静态成员函数
};
```

静态成员变量为所有对象共享，且`sizeof`运算符不会计算静态成员变量

```cpp
class CMyclass{
    int n;
    static int s;
};
//sizeof(CMyclass) 等于 4
```

普通成员变量每个对象有各自的一份，而静态成员变量一共就一份，为所有对象共享

普通成员函数必须具体作用于某个对象，而静态成员函数并不具体作用于某个对象。所以实际上静态成员不需要通过对象就能访问。

### 如何访问静态成员

#### 1.类型::成员名

```cpp
CRectangle::PrintTotal();
```

#### 2.对象名.成员名

```cpp
CRectangle r;
r.PrintTotal();
```

#### 3.指针->成员名

```cpp
CRectangle * p = &r;
p -> PrintTotal();
```

#### 4.引用.成员名

```cpp
CRectangle & ref = r;
int n = ref.nTotalNumber;
```

静态成员变量本质上是全局变量，哪怕一个对象都不存在，类的静态成员变量也存在

静态成员函数本质上是全局函数，主要目的是将和某些类紧密相关的全局变量和函数写到类里面，看上去想一个整体，易于维护和理解

```cpp
class CRectangle
{
    private:
    	int w, h;
    		static int nTotalArea;		//静态成员变量
    		static int nTotalNumber;
    public:
    		CRectangle(int w_, int h_);
    		~CRectangle();
    		static void PrintTotal();		//静态成员函数
};

CRectangle::CRectangle(int w_,int h_ )
{
    w = w_;
    h = h_;
    nTotalNmuber ++;
    nTotalArea += w * h;
}

CRectangle::~CRectangle()
{
    nTotalNumber --;
    nTotalArea -= w * h;
}

void CRectangle::PrintTotal()
{
    cout << nTotalNumber << "," <<nTotalArea <<endl;
}

int CRectangle::nTotalNumber = 0;
int CRectangle::nTotalNumber = 0;
//必须在定义类的文件中对静态函数变量进行以此说明或初始化
//否则编译能通过，链接１不能通过

int main()
{
    CRectangle r1( 3, 3 ), r2(2, 2);
    cout << CRectangle::nTotalNumber;				//error,私有
   	CRectangle::PrintTotal();
    r1.PrintTotal();
    return 0;
}

//输出：
//2,13
//2,13
```

要注意的是：在静态成员函数中，不能访问非静态成员变量，也不能调用非静态成员函数

```cpp
void CRectangle::PrintTotal()
{
    cout << w << "," << nTotalNumber << "," << nTotalArea << endl;		//error
}
CRectangle::PrintTotal();	//解释不通，w到底属于哪个对象？
```

## 三 成员对象和封闭类

